{% extends "base.html" %}
{% block title %}Utilization{% endblock %}
{% block content %}
<body class="g-sidenav-show h-100 bg-gray-100">
 {% include "sidenav.html" %}
    <div class="container-fluid py-4 flex-grow-1 d-flex flex-column">
      <div class="row">
        <div class="col position-relative z-index-2">
          <div class="card card-plain mb-4">
            <div class="card-body p-3">
              <div class="row">
                <div class="col-lg-6">
                  <div class="d-flex flex-column h-100">
                    <h2 class="font-weight-bolder mb-0">Utilization</h2>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-4">
              <div class="card ">
                <div class="card-body p-3">
                  <div class="row">
                    <div class="col-8">
                      <div class="numbers">
                        <p class="mb-0 text-sm text-capitalize font-weight-bold">Total Hours</p>
                        <h4 class="font-weight-bolder mb-0">
                          {{ total_hours }}
                        </h4>
                      </div>
                    </div>
                    <div class="col-4 text-end">
                      <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                        <i class="far fa-clock text-lg opacity-10" aria-hidden="true"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-4">
              <div class="card ">
                <div class="card-body p-3">
                  <div class="row">
                    <div class="col-8">
                      <div class="numbers">
                        <p class="mb-0 text-sm text-capitalize font-weight-bold">Total Billable Hours</p>
                        <h4 class="font-weight-bolder mb-0">
                          {{ total_billable }}
                        </h4>
                      </div>
                    </div>
                    <div class="col-4 text-end">
                      <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                        <i class="fas fa-dollar-sign text-lg opacity-10" aria-hidden="true"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-4">
              <div class="card ">
                <div class="card-body p-3">
                  <div class="row">
                    <div class="col-8">
                      <div class="numbers">
                        <p class="mb-0 text-sm text-capitalize font-weight-bold">Overall Utilization</p>
                        <h4 class="font-weight-bolder mb-0">
                          {{ overall_utilization_rate_formatted }}
                        </h4>
                      </div>
                    </div>
                    <div class="col-4 text-end">
                      <div class="icon icon-shape bg-gradient-primary shadow text-center border-radius-md">
                        <i class="fas fa-chart-line text-lg opacity-10" aria-hidden="true"></i>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <form method="post" action="{{ url_for('tenadams.utilization') }}" class="utilization-form">
            <div class="row align-items-end">
              <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="form-group">
                  <label for="start_date">Start Date:</label>
                  <input type="text" class="form-control datepicker" id="start_date" name="start_date" value="{{ start_date }}" required>
                </div>
              </div>
              <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="form-group">
                  <label for="end_date">End Date:</label>
                  <input type="text" class="form-control datepicker" id="end_date" name="end_date" value="{{ end_date }}" required>
                </div>
              </div>
              <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="form-group">
                  <label for="department">Department:</label>
                  <select id="department" name="department" class="form-control">
                    <option value="">Select a department</option>
                    {% for dep in departments %}
                    <option value="{{ dep }}" {% if dep == request.form.get('department') %}selected{% endif %}>{{ dep }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="form-group">
                  <label for="user">User:</label>
                  <select id="user" name="user" class="form-control">
                    <option value="">Select a user</option>
                    {% for user in users %}
                    {% if not selected_department or user['User_Department'] == selected_department %}
                    <option value="{{ user['User_Full_Name'] }}" data-department="{{ user['User_Department'] }}" {% if user['User_Full_Name'] == request.form.get('user') %}selected{% endif %}>{{ user['User_Full_Name'] }}</option>
                    {% endif %}
                    {% endfor %}
                  </select>
                </div>
              </div>    
              <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="form-group">
                  <button class="btn btn-primary btn-block" type="submit" style="margin-top: 31px;">Filter</button>
                </div>
              </div>
            </div>
          </form>

          <!-- Utilization Section -->
          {% if not utilization_df.empty %}

          <div class="row">
            <div class="col">
              <div class="card">
                <div class="card-body p-3">
                  <h4 class="font-weight-bolder mb-0">Utilization by Person</h4>
                </div>
                <div class="table-responsive">
                  <table class="table align-items-center mb-0">
                    <thead>
                      <tr>
                        <th class="text-uppercase text-xxs font-weight-bolder opacity-7">User Full Name</th>
                        <th class="text-center text-uppercase text-xxs font-weight-bolder opacity-7">Total Hours</th>
                        <th class="text-center text-uppercase text-xxs font-weight-bolder opacity-7">Billable Hours</th>
                        <th class="text-center text-uppercase text-xxs font-weight-bolder opacity-7">Utilization Rate</th>
                        <th class="text-center text-uppercase text-xxs font-weight-bolder opacity-7">Rate Goal</th>
                        <th class="text-end text-uppercase text-xxs font-weight-bolder opacity-7">+/- Target</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for index, row in utilization_df.iterrows() %}
                      <tr>
                        <td>
                          <div class="d-flex px-2 py-1">
                            <div>
                              <img src="{{ row['photo_url'] }}" class="avatar avatar-sm me-3" alt="User's Profile Photo">
                          </div>                          
                            <div class="d-flex flex-column justify-content-center">
                              <h6 class="mb-0">{{ row['User_Full_Name'] }}</h6>
                            </div>
                          </div>
                        </td>
                        <td class="text-center">
                          <p class="font-weight-bold mb-0">{{ row['total_actual_hours'] }}</p>
                        </td>
                        <td class="text-center">
                          <p class="font-weight-bold mb-0">{{ row['total_billable_hours'] }}</p>
                        </td>
                        <td class="text-center">
                          <p class="font-weight-bold mb-0">{{ '{:.1f}'.format(row['utilization_rate'] * 100) }}%</p>
                        </td>
                        <td class="text-center">
                          <p class="font-weight-bold mb-0">{{ '{:.1f}'.format(row['Rate_Goal'] * 100) }}%</p>
                        </td>
                        <td class="text-end px-4">
                          <p class="font-weight-bold mb-0">{{ '{:.1f}'.format((row['utilization_rate'] - row['Rate_Goal']) * 100) }}% 
                            <i class="{{
                              'text-success fas fa-circle-dot' if row['Rate_Goal'] - row['utilization_rate'] < 0 else
                              'text-danger fas fa-circle-dot' if row['Rate_Goal'] - row['utilization_rate'] > 0.1 else
                              'text-warning fas fa-circle-dot'
                            }}"></i></p>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
          <!-- Working Time Section -->
      <div class="row mt-4">
        <div class="col-lg-5 mb-lg-0 mb-4">
          <div class="card">
            <div class="card-body p-3">
              <h4 class="font-weight-bolder mb-0">
                Working Time
              </h4>
            </div>
            <div class="table-responsive">
              <table class="table align-items-center mb-1">
                <thead>
                  <tr>
                    <th class="text-uppercase text-xxs font-weight-bolder opacity-7 px-3">User Full Name</th>
                    <th class="text-uppercase text-xxs font-weight-bolder opacity-7 px-3">Working Time</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div>
                          <img src="https://demos.creative-tim.com/soft-ui-design-system-pro/assets/img/team-1.jpg" class="avatar avatar-sm me-3">
                        </div>
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0">Brandon Scott</h6>
                        </div>
                      </div>
                    </td>
                    <td class="px-3">
                      <p class="text-sm font-weight-bold mb-2">131.9%</p>
                      <div class="progress w-100">
                        <div class="progress-bar bg-dark w-100" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div>
                          <img src="https://demos.creative-tim.com/soft-ui-design-system-pro/assets/img/team-2.jpg" class="avatar avatar-sm me-3">
                        </div>
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0">Brennen Small</h6>
                        </div>
                      </div>
                    </td>
                    <td class="px-3">
                      <p class="text-sm font-weight-bold mb-2">105.0%</p>
                      <div class="progress w-100">
                        <div class="progress-bar bg-dark w-100" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div>
                          <img src="https://demos.creative-tim.com/soft-ui-design-system-pro/assets/img/team-3.jpg" class="avatar avatar-sm me-3">
                        </div>
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0">Jeff A May</h6>
                        </div>
                      </div>
                    </td>
                    <td class="px-3">
                      <p class="text-sm font-weight-bold mb-2">105.0%</p>
                      <div class="progress w-100">
                        <div class="progress-bar bg-dark w-100" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div>
                          <img src="https://demos.creative-tim.com/soft-ui-design-system-pro/assets/img/team-4.jpg" class="avatar avatar-sm me-3">
                        </div>
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0">Jordyn Sallee</h6>
                        </div>
                      </div>
                    </td>
                    <td class="px-3">
                      <p class="text-sm font-weight-bold mb-2">103.1%</p>
                      <div class="progress w-100">
                        <div class="progress-bar bg-dark w-100" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div>
                          <img src="https://demos.creative-tim.com/soft-ui-design-system-pro/assets/img/team-5.jpg" class="avatar avatar-sm me-3">
                        </div>
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0">Kris A Laufer</h6>
                        </div>
                      </div>
                    </td>
                    <td class="px-3">
                      <p class="text-sm font-weight-bold mb-2">103.1%</p>
                      <div class="progress w-100">
                        <div class="progress-bar bg-dark w-100" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div>
                          <img src="https://demos.creative-tim.com/soft-ui-design-system-pro/assets/img/team-2.jpg" class="avatar avatar-sm me-3">
                        </div>
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0">Alison Myers</h6>
                        </div>
                      </div>
                    </td>
                    <td class="px-3">
                      <p class="text-sm font-weight-bold mb-2">101.2%</p>
                      <div class="progress w-100">
                        <div class="progress-bar bg-dark w-100" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div>
                          <img src="https://demos.creative-tim.com/soft-ui-design-system-pro/assets/img/team-3.jpg" class="avatar avatar-sm me-3">
                        </div>
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0">Andrew Fought</h6>
                        </div>
                      </div>
                    </td>
                    <td class="px-3">
                      <p class="text-sm font-weight-bold mb-2">87.5%</p>
                      <div class="progress w-100">
                        <div class="progress-bar bg-dark w-85" role="progressbar" aria-valuenow="88" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div>
                          <img src="https://demos.creative-tim.com/soft-ui-design-system-pro/assets/img/team-1.jpg" class="avatar avatar-sm me-3">
                        </div>
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0">Desiree M Stallings</h6>
                        </div>
                      </div>
                    </td>
                    <td class="px-3">
                      <p class="text-sm font-weight-bold mb-2">82.6%</p>
                      <div class="progress w-100">
                        <div class="progress-bar bg-dark w-80" role="progressbar" aria-valuenow="83" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div>
                          <img src="https://demos.creative-tim.com/soft-ui-design-system-pro/assets/img/team-2.jpg" class="avatar avatar-sm me-3">
                        </div>
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0">Kaitlyn R Brinker</h6>
                        </div>
                      </div>
                    </td>
                    <td class="px-3">
                      <p class="text-sm font-weight-bold mb-2">81.9%</p>
                      <div class="progress w-100">
                        <div class="progress-bar bg-dark w-80" role="progressbar" aria-valuenow="82" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div>
                          <img src="https://demos.creative-tim.com/soft-ui-design-system-pro/assets/img/team-3.jpg" class="avatar avatar-sm me-3">
                        </div>
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0">Ashley Johnson</h6>
                        </div>
                      </div>
                    </td>
                    <td class="px-3">
                      <p class="text-sm font-weight-bold mb-2">77.5%</p>
                      <div class="progress w-100">
                        <div class="progress-bar bg-dark w-75" role="progressbar" aria-valuenow="78" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div>
                          <img src="https://demos.creative-tim.com/soft-ui-design-system-pro/assets/img/team-5.jpg" class="avatar avatar-sm me-3">
                        </div>
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0">Rachael Frey</h6>
                        </div>
                      </div>
                    </td>
                    <td class="px-3">
                      <p class="text-sm font-weight-bold mb-2">58.1%</p>
                      <div class="progress w-100">
                        <div class="progress-bar bg-dark w-60" role="progressbar" aria-valuenow="58" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </td>
                  </tr>
                  <tr>
                    <td>
                      <div class="d-flex px-2 py-1">
                        <div>
                          <img src="https://demos.creative-tim.com/soft-ui-design-system-pro/assets/img/team-4.jpg" class="avatar avatar-sm me-3">
                        </div>
                        <div class="d-flex flex-column justify-content-center">
                          <h6 class="mb-0">Jennifer D Horton</h6>
                        </div>
                      </div>
                    </td>
                    <td class="px-3">
                      <p class="text-sm font-weight-bold mb-2">40.0%</p>
                      <div class="progress w-100">
                        <div class="progress-bar bg-dark w-40" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"></div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-lg-7">
          <div class="card z-index-2">
            <div class="card-header pb-0">
              <h6>Sales overview</h6>
              <p class="text-sm">
                <i class="fa fa-arrow-up text-success"></i>
                <span class="font-weight-bold">4% more</span> in 2021
              </p>
            </div>
            <div class="card-body p-3">
              <div class="chart">
                <canvas id="chart-line" class="chart-canvas" height="300"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>      
      
      <footer class="footer pt-3 mt-auto ">
        <div class="container-fluid">
          <div class="row align-items-center justify-content-lg-between">
            <div class="col-lg-12 mb-lg-0 mb-4">
              <div class="copyright text-center text-sm text-muted text-lg-start">
                Copyright © Ten Adams, Inc. <script>document.write(new Date().getFullYear())</script>
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>
  </main>

{% include '_corejs.html' %}
       <!-- Datepicker scripts --> 
       <script src="/static/assets/js/plugins/flatpickr.min.js"></script>
       <script>
         // Datepicker
         if (document.querySelector('.datepicker')) {
           flatpickr('.datepicker', {
             mode: "single"
           });
         }
        </script>
  
<script>


  var ctx2 = document.getElementById("chart-line").getContext("2d");

  var gradientStroke1 = ctx2.createLinearGradient(0, 230, 0, 50);

  gradientStroke1.addColorStop(1, 'rgba(203,12,159,0.2)');
  gradientStroke1.addColorStop(0.2, 'rgba(72,72,176,0.0)');
  gradientStroke1.addColorStop(0, 'rgba(203,12,159,0)'); //purple colors

  var gradientStroke2 = ctx2.createLinearGradient(0, 230, 0, 50);

  gradientStroke2.addColorStop(1, 'rgba(20,23,39,0.2)');
  gradientStroke2.addColorStop(0.2, 'rgba(72,72,176,0.0)');
  gradientStroke2.addColorStop(0, 'rgba(20,23,39,0)'); //purple colors

  new Chart(ctx2, {
    type: "line",
    data: {
      labels: ["Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
      datasets: [{
          label: "Mobile apps",
          tension: 0.4,
          borderWidth: 0,
          pointRadius: 0,
          borderColor: "#cb0c9f",
          borderWidth: 3,
          backgroundColor: gradientStroke1,
          fill: true,
          data: [50, 40, 300, 220, 500, 250, 400, 230, 500],
          maxBarThickness: 6

        },
        {
          label: "Websites",
          tension: 0.4,
          borderWidth: 0,
          pointRadius: 0,
          borderColor: "#3A416F",
          borderWidth: 3,
          backgroundColor: gradientStroke2,
          fill: true,
          data: [30, 90, 40, 140, 290, 290, 340, 230, 400],
          maxBarThickness: 6
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false,
        }
      },
      interaction: {
        intersect: false,
        mode: 'index',
      },
      scales: {
        y: {
          grid: {
            drawBorder: false,
            display: true,
            drawOnChartArea: true,
            drawTicks: false,
            borderDash: [5, 5]
          },
          ticks: {
            display: true,
            padding: 10,
            color: '#b2b9bf',
            font: {
              size: 11,
              family: "Open Sans",
              style: 'normal',
              lineHeight: 2
            },
          }
        },
        x: {
          grid: {
            drawBorder: false,
            display: false,
            drawOnChartArea: false,
            drawTicks: false,
            borderDash: [5, 5]
          },
          ticks: {
            display: true,
            color: '#b2b9bf',
            padding: 20,
            font: {
              size: 11,
              family: "Open Sans",
              style: 'normal',
              lineHeight: 2
            },
          }
        },
      },
    },
  });


  (function() {
    const container = document.getElementById("globe");
    const canvas = container.getElementsByTagName("canvas")[0];

    const globeRadius = 100;
    const globeWidth = 4098 / 2;
    const globeHeight = 1968 / 2;

    function convertFlatCoordsToSphereCoords(x, y) {
      let latitude = ((x - globeWidth) / globeWidth) * -180;
      let longitude = ((y - globeHeight) / globeHeight) * -90;
      latitude = (latitude * Math.PI) / 180;
      longitude = (longitude * Math.PI) / 180;
      const radius = Math.cos(longitude) * globeRadius;

      return {
        x: Math.cos(latitude) * radius,
        y: Math.sin(longitude) * globeRadius,
        z: Math.sin(latitude) * radius
      };
    }

    function makeMagic(points) {
      const {
        width,
        height
      } = container.getBoundingClientRect();

      // 1. Setup scene
      const scene = new THREE.Scene();
      // 2. Setup camera
      const camera = new THREE.PerspectiveCamera(45, width / height);
      // 3. Setup renderer
      const renderer = new THREE.WebGLRenderer({
        canvas,
        antialias: true
      });
      renderer.setSize(width, height);
      // 4. Add points to canvas
      // - Single geometry to contain all points.
      const mergedGeometry = new THREE.Geometry();
      // - Material that the dots will be made of.
      const pointGeometry = new THREE.SphereGeometry(0.5, 1, 1);
      const pointMaterial = new THREE.MeshBasicMaterial({
        color: "#989db5",
      });

      for (let point of points) {
        const {
          x,
          y,
          z
        } = convertFlatCoordsToSphereCoords(
          point.x,
          point.y,
          width,
          height
        );

        if (x && y && z) {
          pointGeometry.translate(x, y, z);
          mergedGeometry.merge(pointGeometry);
          pointGeometry.translate(-x, -y, -z);
        }
      }

      const globeShape = new THREE.Mesh(mergedGeometry, pointMaterial);
      scene.add(globeShape);

      container.classList.add("peekaboo");

      // Setup orbital controls
      camera.orbitControls = new THREE.OrbitControls(camera, canvas);
      camera.orbitControls.enableKeys = false;
      camera.orbitControls.enablePan = false;
      camera.orbitControls.enableZoom = false;
      camera.orbitControls.enableDamping = false;
      camera.orbitControls.enableRotate = true;
      camera.orbitControls.autoRotate = true;
      camera.position.z = -265;

      function animate() {
        // orbitControls.autoRotate is enabled so orbitControls.update
        // must be called inside animation loop.
        camera.orbitControls.update();
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      }
      animate();
    }

    function hasWebGL() {
      const gl =
        canvas.getContext("webgl") || canvas.getContext("experimental-webgl");
      if (gl && gl instanceof WebGLRenderingContext) {
        return true;
      } else {
        return false;
      }
    }

    function init() {
      if (hasWebGL()) {
        window
        window.fetch("https://raw.githubusercontent.com/creativetimofficial/public-assets/master/soft-ui-dashboard-pro/assets/js/points.json")
          .then(response => response.json())
          .then(data => {
            makeMagic(data.points);
          });
      }
    }
    init();
  })();
</script>

  
  {% endblock %}
