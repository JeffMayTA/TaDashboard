{% extends "base.html" %}
{% block title %}Service Codes{% endblock %}
{% block bodyclass %}g-sidenav-show h-100 bg-gray-100{% endblock %}

{% block content %}
  <div class="row">
    <div class="col position-relative z-index-2">
      <div class="card card-plain mb-4">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-lg-6">
              <div class="d-flex flex-column h-100">
                <h2 class="font-weight-bolder mb-0">Service Codes</h2>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <div class="card mb-4">
            <div class="card-body p-3">
              <form method="post" action="{{ url_for('tenadams.service_description_chart') }}" class="utilization-form">
                <div class="row align-items-end">
                  <div class="col-lg-2 col-sm-6">
                    <div class="form-group">
                      <label for="start_date">Start Date:</label>
                      <input type="text" class="form-control datepicker" id="start_date" name="start_date" value="{{ start_date }}" required>
                    </div>
                  </div>
                  <div class="col-lg-2 col-sm-6">
                    <div class="form-group">
                      <label for="end_date">End Date:</label>
                      <input type="text" class="form-control datepicker" id="end_date" name="end_date" value="{{ end_date }}" required>
                    </div>
                  </div>
                  <div class="col-lg-3 col-sm-6">
                    <div class="form-group">
                      <label for="department">Department:</label>
                      <select id="department" name="department" class="form-control">
                        <option value="">Select a department</option>
                        {% for dep in departments %}
                          {% if is_admin or dep == user_department %}
                          {% set display_department = selected_department if selected_department else user_department %}
                          <option value="{{ dep }}" {{ 'selected' if dep == display_department }}>{{ dep }}</option>                            
                          {% endif %}
                        {% endfor %}
                    </select>
                    </div>
                  </div>
                  <div class="col-lg-3 col-sm-6">
                    <div class="form-group">
                      <label for="user">User:</label>
                      <select id="user" name="user" class="form-control">
                        <option value="">Select a user</option>
                        {% for user in users %}
                          {% if not user_department or user['User_Department'] == user_department %}
                          <option value="{{ user['User_Full_Name'] }}" data-department="{{ user['User_Department'] }}" {{ 'selected' if user['User_Full_Name'] == request.form.get('user') }}>{{ user['User_Full_Name'] }}</option>
                          {% endif %}
                        {% endfor %}
                      </select>
                    </div>
                  </div>
                  
                  <div class="col-lg-2 col-sm-12">
                    <div class="form-group">
                      <button class="btn btn-primary btn-block w-100 m-0" type="submit">Filter</button>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
      <!-- Pie chart for Service Code Summary -->
      <div class="card mb-4">
        <div class="card-body p-3">
          <h4 class="font-weight-bolder mb-3">Service Code Breakdown</h4>
          <div class="row">
            <div class="col-xxl-5 mb-4">
              <div class="chart">
                <canvas id="service-code-chart" class="chart-canvas" height="300"></canvas>
              </div>
            </div>
            <div class="col-xxl-7">
              <div class="table-responsive">
                <table class="table align-items-center mb-0">
                  <tbody id="service-code-chart-legend" class="legend-container">
                    
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% include '_corejs.html' %}

  <!-- Datepicker scripts --> 
  <script src="/static/assets/js/plugins/flatpickr.min.js"></script>
  <script>
    // Datepicker
    if (document.querySelector('.datepicker')) {
      flatpickr('.datepicker', {
        mode: "single"
      });
    }
  </script>
  
  <script>
    // Register the plugin
    Chart.register(ChartDataLabels);
  
    /// Create the pie chart for Service Descriptions
    const serviceCodeCtx = document.getElementById('service-code-chart').getContext('2d');
    const serviceCodeData = {
      labels: {{ labels|tojson }}, // Use the labels you passed from the backend
      datasets: [{
        data: {{ data_values|tojson }}, // Use the data values you passed from the backend
        backgroundColor: ["#FF0000", "#FFA500", "#cc9900", "#008000", "#0000FF", "#4B0082", "#9400D3", "#FF00FF", "#00FF00", "#FF1493", "#00FFFF", "#800000", "#FFC0CB", "#00FF7F", "#FF8C00", "#FF0000", "#FFA500", "#cc9900", "#008000", "#0000FF", "#4B0082", "#9400D3", "#FF00FF", "#00FF00", "#FF1493", "#00FFFF", "#800000", "#FFC0CB", "#00FF7F", "#FF8C00", "#FFA500", "#cc9900", "#008000", "#0000FF", "#4B0082", "#9400D3", "#FF00FF", "#00FF00", "#FF1493", "#00FFFF", "#800000", "#FFC0CB", "#00FF7F", "#FF8C00", "#FF0000", "#FFA500", "#cc9900", "#008000", "#0000FF", "#4B0082", "#9400D3", "#FF00FF", "#00FF00", "#FF1493", "#00FFFF", "#800000", "#FFC0CB", "#00FF7F", "#FF8C00"], // Colors for pie slices
        borderWidth: 1
      }]
    };
    const serviceCodePieChart = new Chart(serviceCodeCtx, {
      type: 'doughnut',
      data: serviceCodeData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        cutoutPercentage: 70,
        plugins: {
          legend: {
            display: false // Disable the built-in legend
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                var dataset = context.dataset;
                var index = context.dataIndex;
                var data = context.chart.data;
                var total = dataset.data.reduce(function(previousValue, currentValue, currentIndex, array) {
                  return previousValue + currentValue;
                });
                var currentValue = dataset.data[index];
                var percentage = Math.floor(((currentValue / total) * 100) + 0.5);
                return data.labels[index] + ": " + percentage + "%";
              }
            }
          },
          datalabels: {
            formatter: function(value, context) {
              var dataset = context.chart.data.datasets[context.datasetIndex];
              var total = dataset.data.reduce(function(previousValue, currentValue, currentIndex, array) {
                return previousValue + currentValue;
              });
              var percentage = Math.floor(((value / total) * 100) + 0.5);
          
              // Only show labels for pie pieces with a percentage greater than or equal to 5%
              if (percentage >= 3 ) {
                return percentage + '%';
              } else {
                return null; // Return null to hide the label for smaller pie pieces
              }
            },
            color: '#fff',
            font: {
              size: 14,
              weight: 'bold',
              shadowColor: 'rgba(0, 0, 0, 0.5)',
              shadowBlur: 5,
              shadowOffsetX: 2,
              shadowOffsetY: 2
            },
            anchor: 'center', // Change anchor to 'center'
            align: 'center', // Change align to 'center'
            offset: 0 // Set offset to 0
          }
        }
      }
    });

    // Manually create the service code legend
    const scLegendContainer = document.getElementById('service-code-chart-legend'); // Make sure you have this container in your HTML

    serviceCodeData.labels.forEach((label, index) => {
      const value = serviceCodeData.datasets[0].data[index];
      if (value > 0) {
        const legendItem = document.createElement('tr');
        const legendItemData = document.createElement('td');
        legendItem.appendChild(legendItemData);

        const legendItemContent = document.createElement('div');
        legendItemContent.classList.add('d-flex', 'px-2', 'py-0');
        legendItemData.appendChild(legendItemContent);

        // Create the color block
        const colorBlock = document.createElement('span');
        colorBlock.classList.add('badge', 'me-3', 'd-block');
        colorBlock.style.backgroundColor = serviceCodePieChart.data.datasets[0].backgroundColor[index];
        legendItemContent.appendChild(colorBlock);

        // Add the service code label
        const labelTextContain = document.createElement('div');
        labelTextContain.classList.add('d-flex', 'flex-column', 'justify-content-center');
        legendItemContent.appendChild(labelTextContain);

        const labelText = document.createElement('h6');
        labelText.classList.add('mb-0', 'text-sm');
        labelText.textContent = label;
        labelTextContain.appendChild(labelText);

        scLegendContainer.appendChild(legendItem);
      }
    });
</script>

  {% endblock %}
